// Generated by CoffeeScript 1.6.2
(function() {
  var container, dataAll, dataGet, dataSet, deepMixin, elements, getOuterHTML, load, lookup, refresh, replaceValues, strings, t7e, translate,
    __hasProp = {}.hasOwnProperty,
    __slice = [].slice;

  strings = {};

  elements = 'div h1 h2 h3 h4 h5 h6 p li td img span a strong b em i'.split(/\s+/);

  dataSet = function(el, key, value) {
    return el.setAttribute("data-t7e-" + (key.toLowerCase()), value);
  };

  dataGet = function(el, key) {
    return el.getAttribute("data-t7e-" + (key.toLowerCase()));
  };

  dataAll = function(el) {
    var attr, data, _i, _len, _ref;

    data = {};
    _ref = el.attributes;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      attr = _ref[_i];
      if ((attr.name.indexOf('data-t7e-')) === 0) {
        data[attr.name.slice('data-t7e-'.length)] = attr.value;
      }
    }
    return data;
  };

  deepMixin = function(base, mixin) {
    var key, value;

    for (key in mixin) {
      if (!__hasProp.call(mixin, key)) continue;
      value = mixin[key];
      if (typeof value === 'string') {
        base[key] = value;
      } else {
        if (!(key in base)) {
          base[key] = {};
        }
        deepMixin(base[key], value);
      }
    }
    return base;
  };

  lookup = function(object, key) {
    var keys, _i, _len;

    keys = key.split('.');
    for (_i = 0, _len = keys.length; _i < _len; _i++) {
      key = keys[_i];
      object = object[key];
    }
    return object || key;
  };

  replaceValues = function(string, values) {
    var key, value;

    for (key in values) {
      value = values[key];
      if ((key.charAt(0)) === '$') {
        string = string.replace(key, value, 'gi');
      }
    }
    return string;
  };

  container = document.createElement('div');

  getOuterHTML = function(element) {
    container.innerHTML = '';
    container.appendChild(element);
    return container.innerHTML;
  };

  translate = function() {
    var element, name, nodeName, options, params, property, translationKey, value, values, _i, _len;

    params = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    if (typeof params[0] === 'string') {
      translationKey = params[0], values = params[1];
      return replaceValues(lookup(strings, translationKey), values);
    } else {
      options = params[0];
      for (_i = 0, _len = elements.length; _i < _len; _i++) {
        name = elements[_i];
        if (name in options) {
          nodeName = name;
        }
      }
      translationKey = options[nodeName];
      element = document.createElement(nodeName);
      if (translationKey) {
        element.innerHTML = replaceValues(lookup(strings, translationKey), options);
      }
      dataSet(element, 'key', translationKey);
      for (property in options) {
        value = options[property];
        if (property !== nodeName) {
          if (property.charAt(0) === '$') {
            dataSet(element, "var-" + property.slice(1), value);
          } else {
            dataSet(element, "attr-" + property, value);
            element.setAttribute(property, translate(value));
          }
        }
      }
      return getOuterHTML(element);
    }
  };

  refresh = function(root) {
    var attr, attrName, attrs, dataAttr, element, key, keyedElements, options, value, varName, _i, _len, _ref;

    if (root == null) {
      root = document.body;
    }
    keyedElements = Array.prototype.slice.call(root.querySelectorAll('[data-t7e-key]'));
    if (dataGet(root, 'key')) {
      keyedElements.unshift(root);
    }
    for (_i = 0, _len = keyedElements.length; _i < _len; _i++) {
      element = keyedElements[_i];
      key = dataGet(element, 'key');
      options = {};
      attrs = {};
      _ref = dataAll(element);
      for (dataAttr in _ref) {
        value = _ref[dataAttr];
        if ((dataAttr.indexOf('var-')) === 0) {
          varName = dataAttr.slice('var-'.length);
          options["$" + varName] = value;
        } else if ((dataAttr.indexOf('attr-')) === 0) {
          attrName = dataAttr.slice('attr-'.length);
          attrs[attrName] = value;
        }
      }
      element.innerHTML = translate(key, options);
      for (attr in attrs) {
        value = attrs[attr];
        element.setAttribute(attr, translate(value));
      }
    }
    return null;
  };

  load = function() {
    var additions, newStrings, _i, _len;

    newStrings = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    for (_i = 0, _len = newStrings.length; _i < _len; _i++) {
      additions = newStrings[_i];
      deepMixin(strings, additions);
    }
    return null;
  };

  t7e = translate;

  t7e.strings = strings;

  t7e.deepMixin = deepMixin;

  t7e.lookup = lookup;

  t7e.replaceValues = replaceValues;

  t7e.getOuterHTML = getOuterHTML;

  t7e.refresh = refresh;

  t7e.load = load;

  if (typeof window !== "undefined" && window !== null) {
    window.t7e = t7e;
  }

  if (typeof module !== "undefined" && module !== null) {
    module.exports = t7e;
  }

}).call(this);
